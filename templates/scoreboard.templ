package templates

import (
	"fmt"
	"github.com/jgoodhcg/mindmeld/internal/db"
)

// getRank returns the 1-based rank for a player, accounting for ties
func getRank(index int, scores []db.GetLobbyScoreboardRow) int {
	if index == 0 {
		return 1
	}
	// If same score as previous player, same rank
	if scores[index].Score == scores[index-1].Score {
		return getRank(index-1, scores)
	}
	// Otherwise, rank is index + 1
	return index + 1
}

templ Scoreboard(scores []db.GetLobbyScoreboardRow, lobbyCode string, isHost bool) {
	<div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-5 sm:p-8 border border-yellow-500/30 shadow-xl">
		<!-- Trophy Header -->
		<div class="text-center mb-8 sm:mb-10">
			<div class="text-6xl sm:text-7xl mb-4">ğŸ†</div>
			<h2 class="text-4xl sm:text-5xl font-bold text-transparent bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-500 bg-clip-text mb-2">
				Final Scores
			</h2>
			<p class="text-gray-400 text-sm sm:text-base">Great game everyone!</p>
		</div>

		<!-- Podium -->
		<div class="space-y-3 max-w-lg mx-auto mb-8 sm:mb-10">
			for i, s := range scores {
				@ScoreRow(i, s, scores)
			}
		</div>

		<!-- Actions -->
		<div class="flex flex-col items-center gap-4">
			if isHost {
				<form action={ templ.SafeURL("/lobbies/" + lobbyCode + "/play-again") } method="POST" class="w-full max-w-md">
					<button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-600 px-8 py-4 rounded-xl font-bold text-xl transition-all shadow-lg hover:shadow-purple-500/50 active:scale-[0.98]">
						ğŸ® Play Again
					</button>
				</form>
			}
			<a href="/" class="text-gray-400 hover:text-white transition-colors text-sm sm:text-base">â† Back to Home</a>
		</div>
	</div>
}

templ ScoreRow(index int, s db.GetLobbyScoreboardRow, scores []db.GetLobbyScoreboardRow) {
	{{ rank := getRank(index, scores) }}
	if rank == 1 {
		<div class="flex items-center justify-between p-4 sm:p-5 rounded-xl bg-gradient-to-r from-yellow-500/20 to-yellow-400/20 border-2 border-yellow-500/50 shadow-lg transform scale-105">
			<div class="flex items-center gap-3 sm:gap-4">
				<span class="text-3xl sm:text-4xl w-10 sm:w-12 flex-shrink-0">ğŸ¥‡</span>
				<span class="text-lg sm:text-xl font-bold text-yellow-300">{ s.Nickname }</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-2xl sm:text-3xl font-bold text-yellow-400">{ fmt.Sprintf("%d", s.Score) }</span>
				<span class="text-xs text-gray-500 uppercase font-bold">pts</span>
			</div>
		</div>
	} else if rank == 2 {
		<div class="flex items-center justify-between p-4 sm:p-5 rounded-xl bg-gradient-to-r from-gray-700/40 to-gray-600/40 border-2 border-gray-600/50">
			<div class="flex items-center gap-3 sm:gap-4">
				<span class="text-3xl sm:text-4xl w-10 sm:w-12 flex-shrink-0">ğŸ¥ˆ</span>
				<span class="text-lg sm:text-xl font-bold text-white">{ s.Nickname }</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-2xl sm:text-3xl font-bold text-gray-300">{ fmt.Sprintf("%d", s.Score) }</span>
				<span class="text-xs text-gray-500 uppercase font-bold">pts</span>
			</div>
		</div>
	} else if rank == 3 {
		<div class="flex items-center justify-between p-4 sm:p-5 rounded-xl bg-gradient-to-r from-orange-900/20 to-orange-800/20 border-2 border-orange-800/50">
			<div class="flex items-center gap-3 sm:gap-4">
				<span class="text-3xl sm:text-4xl w-10 sm:w-12 flex-shrink-0">ğŸ¥‰</span>
				<span class="text-lg sm:text-xl font-bold text-white">{ s.Nickname }</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-2xl sm:text-3xl font-bold text-orange-400">{ fmt.Sprintf("%d", s.Score) }</span>
				<span class="text-xs text-gray-500 uppercase font-bold">pts</span>
			</div>
		</div>
	} else {
		<div class="flex items-center justify-between p-4 sm:p-5 rounded-xl bg-gray-900/40 border-2 border-gray-700/50">
			<div class="flex items-center gap-3 sm:gap-4">
				<span class="text-xl sm:text-2xl font-bold text-gray-500 w-10 sm:w-12 flex-shrink-0">#{ fmt.Sprintf("%d", rank) }</span>
				<span class="text-lg sm:text-xl font-bold text-white">{ s.Nickname }</span>
			</div>
			<div class="flex items-center gap-2">
				<span class="text-2xl sm:text-3xl font-bold text-gray-400">{ fmt.Sprintf("%d", s.Score) }</span>
				<span class="text-xs text-gray-500 uppercase font-bold">pts</span>
			</div>
		</div>
	}
}
